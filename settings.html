<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>deskgen settings</title>
  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
    }
    div {
      margin: 16px
    }

    ul {
      list-style-type: none;
    }

    #dutyLists>ul {
      padding: 0;
    }

    table {
      text-align: left;
      border-collapse: collapse;
      /*border-style: hidden;*/
    }

    table, th{
      /* border: 1px solid black; */
    }
    td {
      /* border-left: 1px solid black; */
      /* border-right: 1px solid black; */
    }
    .headerGroup1{
      border-top: 4px solid #8b89c3;
    }
    /* .headerGroup1:nth-child(1 of .headerGroup1){
      border-left: 4px solid #8b89c3;
    } */
    .headerGroup2{
      border-top: 4px solid darksalmon;
    }
    /* .headerGroup2:nth-child(1 of .headerGroup2){
      border-left: 4px solid darksalmon;
    } */
    /* .headerGroup2:nth-last-child(1 of .headerGroup2){
      border-right: 4px solid darksalmon;
    } */
    
    #stations tr>th:first-of-type {
      background-color: white;
      border: 1px solid white;
      /* border-right: 1px solid black; */
    }

    #stations tr>td:last-of-type,
    #stations tr>th:last-of-type {
      background-color: white;
      border: 1px solid white;
      /* border-left: 1px solid black; */
    }

    tbody tr:nth-child(even) {
      background-color: #e4e4e4;
    }
    tbody tr:nth-child(odd) {
      background-color: #c7c7c7;
    }

    td, th {
      width: 1px;
      white-space: nowrap;
      padding: 0px 4px;
      height: 32px;
      font-size: 0.9em;
    }

    td>input {
      width: calc(100% - 8px);
    }

    .handle {
      cursor: grab;
      font-style: normal;
    }
    .handleParent:hover {
      background-color: #ffffff;
    }

    .template {
      display: none;
    }

    .hidden-list {
      display: none;
      padding: 0;
      cursor: grab;
    }

    .hideList, .buttonSort, .buttonFlip {
      display: none;
    }

    .buttonRemove:hover {
      background-color: #da321c;
      color: white;
    }

    #kvSettings {
      text-align: left;
    }

    #durationType > select{
      width: 96px;
    }

    #limitType > select {
      width: 96px;
    }

    #color > input {
      width: 110%;
    }

    .buttonAdd{
      margin: 12px 16px;
    }

    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      margin: 0px;
      display: inline-block;
      font-style: bold;
      font-size: 1em;
    }
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      margin: 0px;
      transition: 0.3s;
    }
    .tab button:hover {
      background-color: #ddd;
    }
    .tab button.active {
      background-color: #0078d4;
      color: white;
    }
    .tabcontent {
      display: none;
      padding: 0px;
      margin: 0px;
    }

    #dutyLists{
      margin: 0px;
      display: flex;
      flex-wrap: wrap;
    }

    #dutyLists>ul:first-of-type{
      display: flex;
      flex-wrap: wrap;
      margin: 8px 0px;
    }

    #dutyLists>ul>li{
      margin-right: 16px;
      margin-bottom: 16px;
      padding: 16px 16px;
      border: 1px solid #aaa;
      border-radius: 4px;
      /* background: #efefef; */
    }

    #dutyLists>ul>li>ul>li{
      margin-left: 16px;
      margin-right: 20px;
    }
    #dutyLists>ul>li>ul>li:nth-child(even){
      background-color: #ccc;
    }
    #dutyLists>ul>li>ul>li:nth-child(odd){
      background-color: #e7e7e7;
    }

    #dutyLists li>ul{
      padding: 4px 0px;
    }

    /* Tooltip container */
    .tooltip {
      position: relative;
      display: inline-block;
      border-bottom: 1px dotted black; /* Add dots under the hoverable text */
      cursor: help;
    }

    /* Tooltip text */
    .tooltiptext {
      visibility: hidden; /* Hidden by default */
      width: 280px;
      background-color: black;
      color: #ffffff;
      text-align: left;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1; /* Ensure tooltip is displayed above content */
      top: 140%;
      left: 0px;
      white-space: normal;
      margin: 0px;
    }

    .tooltiptext::after {
      content: " ";
      position: absolute;
      bottom: 100%;
      left: 16px; /* To the left of the tooltip */
      margin-left: -12px;
      border-width: 8px;
      border-style: solid;
      border-color: transparent transparent black transparent;
    }

    /* Show the tooltip text on hover */
    .tooltip:hover .tooltiptext {
      visibility: visible;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <!-- <script type="module" src="./sortablejs/modular/sortable.complete.esm.js">import Sortable from './sortablejs/modular/sortable.complete.esm.js'</script> -->
</head>

<body>
  <div class="tab">
    <button class="tablinks" onclick="openTab(event, 'settingsTab')">Settings</button>
    <button class="tablinks" onclick="openTab(event, 'stationsTab')">Stations</button>
    <button class="tablinks" onclick="openTab(event, 'dutiesTab')">Duties</button>
    <button class="tablinks" onclick="openTab(event, 'openHoursTab')">Open Hours</button>
  </div>

  <div id="settingsTab" class="tabcontent">
    <table id="kvSettings">
      <tr class="template"><td>template</td><td><input type="text" class="template"></td></tr>
      <tr><td>assignStations</td><td><input type="checkbox" id="assignStations" checked></td></tr>
      <tr><td>defragPrePass</td><td><input type="checkbox" id="defragPrePass" checked></td></tr>
      <tr><td>changeOnTheHour</td><td><input type="checkbox" id="changeOnTheHour" checked></td></tr>
      <tr><td>generatePicAssignments</td><td><input type="checkbox" id="generatePicAssignments" checked></td></tr>
      <tr><td>groupPicsAtTop</td><td><input type="checkbox" id="groupPicsAtTop" checked></td></tr>
      <tr><td>assignmentLength</td><td><input type="number" id="assignmentLength" value="2"></td></tr>
      <tr><td>mealBreakLength</td><td><input type="number" id="mealBreakLength" value="0.5"></td></tr>
      <tr><td>idealEarlyMealHour</td><td><input type="time" value="12:00" id="idealEarlyMealHour"></td></tr>
      <tr><td>idealLateMealHour</td><td><input type="time" value="17:00" id="idealLateMealHour"></td></tr>
      <tr><td>idealMealTimePlusMinusHours</td><td><input type="number" id="idealMealTimePlusMinusHours" value="1"></td></tr>
      <tr><td>addNamesToEvents</td><td><input type="checkbox" id="addNamesToEvents"></td></tr>
      <tr><td>alwaysShowBranchManager</td><td><input type="checkbox" id="alwaysShowBranchManager"></td></tr>
      <tr><td>alwaysShowAssistantBranchManager</td><td><input type="checkbox" id="alwaysShowAssistantBranchManager"></td></tr>
      <tr><td>alwaysShowAllStaff</td><td><input type="checkbox" id="alwaysShowAllStaff"></td></tr>
      <tr><td>earliestDisplayTime</td><td><input type="time" value="08:30" id="earliestDisplayTime"></td></tr>
      <tr><td>locationID</td><td><input type="text" id="locationID"></td></tr>
      <tr><td>googleCalendarID</td><td><input type="text" id="googleCalendarID"></td></tr>
      <tr><td>archiveSheetURL</td><td><input type="text" id="archiveSheetURL"></td></tr>
      <tr><td>verboseLog</td><td><input type="checkbox" id="verboseLog"></td></tr>
    </table>
  </div>

  <div id="openHoursTab" class="tabcontent">
    <table id="openHours">
      <tr>
        <th></th>
        <th>Open</th>
        <th>Close</th>
      </tr>
      <tr><td>Sunday</td><td><input type="time" value="13:00"></td><td><input type="time" value="17:00"></td></tr>
      <tr><td>Monday</td><td><input type="time" value="09:00"></td><td><input type="time" value="20:00"></td></tr>
      <tr><td>Tuesday</td><td><input type="time" value="09:00"></td><td><input type="time" value="20:00"></td></tr>
      <tr><td>Wednesday</td><td><input type="time" value="09:00"></td><td><input type="time" value="20:00"></td></tr>
      <tr><td>Thursday</td><td><input type="time" value="09:00"></td><td><input type="time" value="20:00"></td></tr>
      <tr><td>Friday</td><td><input type="time" value="09:00"></td><td><input type="time" value="17:00"></td></tr>
      <tr><td>Saturday</td><td><input type="time" value="09:00"></td><td><input type="time" value="17:00"></td></tr>
    </table>
  </div>

  <div id="dutiesTab" class="tabcontent">
    <div id="dutyLists">
      <ul>
        <li class="template">
          <i class="handle">âœ¥</i>
          <input type="text" class="title" value="Duties" style="width: 244px;"><button class="buttonRemove">-</button>
          <span style="display: block; padding-left: 20px;"><input type="number" class="limitXHours" value="0" style="width: 34px"> to <input type="number" class="limitYHours" value="0" style="width: 34px"> hours <select class="limitType"><option>before open</option><option>after open</option><option>before close</option></select></span>
          <ul>
            <li class="template"><i class="handle">âœ¥</i><input type="text" value=""><button
                class="buttonRemove">-</button></li>
            <li><i class="handle">âœ¥</i><input type="text" value=""><button class="buttonRemove">-</button>
            </li>
          </ul>
          <button class="buttonAdd" style="margin-left: 40px;">add duty</button>
        </li>
      </ul>
      <button class="buttonAdd">add list</button>
    </div>
  </div>

  <div id="stationsTab" class="tabcontent">
    <div id="stations" style="margin: 16px 0px 0px 0px;">
      <table>
        <thead>
          <tr class="header">
            <th></th>
            <th><span class="tooltip">Color<p class="tooltiptext">The color used on the station timeline and station key. You can adjust this, but for stations used by all/most branches (like Available, Program/Meeting, Front Desk), keep the default color if possible so that they're consistent across the system, and easy to read by staff not normally on your schedule.</p></span></th>
            <th><span class="tooltip">Station Name<p class="tooltiptext">The name displayed in the station key.</p></span></th>
            <th><span class="tooltip">Group<p class="tooltiptext">For schedules with multiple floors, this number/word is used to group stations within floors. Should only be used at Central.</p></span></th>
            <th><span class="tooltip">Positions<p class="tooltiptext">List of positions which can be assigned to this station, ordered by priority - positions at the top will be preferred over those at the bottom. Click and drag the âœ¥ handles to change this order. Uncheck positions to make them inelgible for assignment.</p></span></th>
            <th class="headerGroup1"><span class="tooltip">Duration Type<p class="tooltiptext">Allows you to specify different duration rules.</p></span></th>
            <th class="headerGroup1"><span class="tooltip">Duration<p class="tooltiptext">How long should staff be assigned to this station before they're rotated to a new one. If left blank, will default to the "assignmentLength" value in Main Settings.</p></span></th>
            <th class="headerGroup2"><span class="tooltip">Limit Type<p class="tooltiptext">Allows you to specify different ways to limit when a station can be assigned.</p></span></th>
            <th class="headerGroup2"><span class="tooltip">X Hours<p class="tooltiptext">Used with the "X to Y hours after open/before close" limit types.</p></span></th>
            <th class="headerGroup2"><span class="tooltip">Y Hours<p class="tooltiptext">Used with the "X to Y hours after open/before close" limit types.</p></span></th>
            <th class="headerGroup2"><span class="tooltip">Start Time<p class="tooltiptext">Used with the "Specific Time" limit type.</p></span></th>
            <th class="headerGroup2"><span class="tooltip">End Time<p class="tooltiptext">Used with the "Specific Time" limit type.</p></span></th>
            <th><span class="tooltip"># of Staff<p class="tooltiptext">How many staff should be assigned to a station at any time.</p></span></th>
            <th></th>
          </tr>
        </thead>
        <tbody>

          <tr class="template handleParent">
            <td class="handleParent"><i class="handle">âœ¥</i></td>
            <td id="color"><input type="color" value="#6aa84f"></td>
            <td id="name"><input type="text" value="Front Desk"></td>
            <td id="group"><input type="text" value=""></td>
            <td id="positionPriority">
              <button class="expandList">edit...</button>
              <button class="hideList">save</button>
              <button class="buttonSort">sort â†“</button>
              <button class="buttonFlip">flip â‡µ</button>
              <ul class="hidden-list">
                <li class="template"><i class="handle">âœ¥</i><input type="checkbox" checked><span>template</span></li>
                <li data-position="Part-Time Library Aide"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Part-Time Library Aide</span></li>
                <li data-position="Part-Time Clerk II"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Part-Time Clerk II</span></li>
                <li data-position="Clerk II"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Clerk II</span></li>
                <li data-position="Senior Clerk"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Senior Clerk</span></li>
                <li data-position="Part-Time Associate Library Specialist"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Part-Time Associate Library Specialist</span></li>
                <li data-position="Associate Library Specialist"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Associate Library Specialist</span></li>
                <li data-position="Part-Time Library Specialist"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Part-Time Library Specialist</span></li>
                <li data-position="Library Specialist"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Library Specialist</span></li>
                <li data-position="Assistant Branch Manager"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Assistant Branch Manager</span></li>
                <li data-position="Branch Manager"><i class="handle">âœ¥</i><input type="checkbox" checked><span>Branch Manager</span></li>
              </ul>
            </td>
            <td id="durationType">
              <select>
                <option>Always while open</option>
                <option>For X hours per day total</option>
                <option>For X hours per day for each staff</option>
              </select>
            </td>
            <td id="duration"><input type="number"></td>
            <td id="limitType">
              <select>
                <option>Specific Time</option>
                <!-- <option>X to Y hours before open</option> -->
                <option>X to Y hours after open</option>
                <option>X to Y hours before close</option>
              </select>
            </td>
            <td id="limitXHours"><input type="number" value=""></td>
            <td id="limitYHours"><input type="number" value=""></td>
            <td id="limitToStartTime"><input type="time"></td>
            <td id="limitToEndTime"><input type="time"></td>
            <td id="numOfStaff"><input type="number" value=""></td>
            <td><button class="buttonCopy">copy</button><button class="buttonRemove">-</button></td>
          </tr>

        </tbody>
      </table>
      <button class="buttonAdd">add</button>
    </div>
  </div>

  <button id="submit" onclick="sendSettings()" style="margin: 32px 0px; width: 120px; height: 40px;">ðŸ’¾ Save all</button>

  <script>
    let defaultOrder = [
      "Branch Manager",
      "Assistant Branch Manager",
      "Library Specialist",
      "Part-Time Library Specialist",
      "Associate Library Specialist",
      "Part-Time Associate Library Specialist",
      "Senior Clerk",
      "Clerk II",
      "Part-Time Clerk II",
      "Part-Time Library Aide",
    ]
    function openTab(evt, tabName) {//https://www.w3schools.com/howto/howto_js_tabs.asp
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
    document.querySelector(".tablinks").click()

    let settingsInput = <?= settings ?>
    let settings = {}
    if (settingsInput.length>0){
      settings = JSON.parse(settingsInput, (k,v)=>v = v===null?undefined:v)
      loadSettings(settings)
    }

    function sendSettings() {
      document.getElementById('submit').innerText="Saving..."
      document.getElementById('submit').disable="true"
      // document.querySelectorAll('.active').style.display = "none"
      exportSettings()
      google.script.run.withSuccessHandler(google.script.host.close)
        .saveSettings(JSON.stringify(settings, (k,v) => v === undefined ? null : v))
      // setTimeout(google.script.host.close, 5000)
    }

    document.getElementById("dutyLists").onclick = function (event) {
      // console.log(event.target.classList)

      if (event.target.classList.contains("buttonAdd")) {
        let dutysContainer = event.target.parentNode
        let list = dutysContainer.querySelector("ul")
        list.appendChild(dutysContainer.querySelector(".template").cloneNode(true)).classList.remove("template")
      }
      if (event.target.classList.contains("buttonRemove")) {
        event.target.parentNode.remove()
      }
    }

    document.getElementById("stations").onclick = function (event) {
      if (event.target.classList.contains("expandList")) {
        event.target.parentNode.querySelector("ul").style.display = "block"
        event.target.parentNode.querySelector(".hideList").style.display = "inline-block"
        event.target.parentNode.querySelector(".buttonSort").style.display = "inline-block"
        event.target.parentNode.querySelector(".buttonFlip").style.display = "inline-block"
        event.target.parentNode.querySelector(".expandList").style.display = "none"
      }
      if (event.target.classList.contains("hideList")) {
        event.target.parentNode.querySelector("ul").style.display = "none"
        event.target.parentNode.querySelector(".hideList").style.display = "none"
        event.target.parentNode.querySelector(".buttonSort").style.display = "none"
        event.target.parentNode.querySelector(".buttonFlip").style.display = "none"
        event.target.parentNode.querySelector(".expandList").style.display = "inline-block"
      }
      if (event.target.classList.contains("buttonAdd")) {
        let stationsContainer = event.target.parentNode
        let list = stationsContainer.querySelector("table tbody")
        let newStation =stationsContainer.querySelector(".template").cloneNode(true)
        list.appendChild(newStation)
        Sortable.create(newStation.querySelector("ul"), {
          animation: 150,
          dataIdAttr: 'data-position'
        })
        newStation.classList.remove("template")

        let positionSoratble = Sortable.get(newStation.querySelector("#positionPriority>ul"))
        console.log(positionSoratble, positionSoratble.toArray())

        newStation.querySelector(".buttonSort").onclick = function(){
          let order = positionSoratble.toArray().filter(pos=>defaultOrder.includes(pos))
          console.log(order)
          order.sort((a,b)=>defaultOrder.indexOf(a) - defaultOrder.indexOf(b))
          console.log(order)
          positionSoratble.sort(order, true)
        }

        newStation.querySelector(".buttonFlip").onclick = function(){
          let order = positionSoratble.toArray()
          positionSoratble.sort(order.reverse(), true)
        }
      }
      if (event.target.classList.contains("buttonRemove")) {
        event.target.parentNode.parentNode.remove()
      }
      if (event.target.classList.contains("buttonCopy")) {
        let station = event.target.parentNode.parentNode
        let stationsContainer = station.parentNode
        station.insertAdjacentElement("beforebegin", station.cloneNode(true))
      }
      if (event.target.parentNode.id == "limitType") {
        updateLimitInputs(event.target.parentNode.parentNode)
      }
    }

    function updateLimitInputs(station){
      let specificTimeStart = station.querySelector("#limitToStartTime > input")
      let specificTimeEnd = station.querySelector("#limitToEndTime > input")
      let limitXHours = station.querySelector("#limitXHours > input")
      let limitYHours = station.querySelector("#limitYHours > input")
      let select = station.querySelector("#limitType > select")
      let value = select.options[select.selectedIndex].innerText
      if (value == "Specific Time") {
        specificTimeStart.disabled = false
        specificTimeEnd.disabled = false
        limitXHours.disabled = true
        limitYHours.disabled = true
      }
      else{
        specificTimeStart.disabled = true
        specificTimeEnd.disabled = true
        limitXHours.disabled = false
        limitYHours.disabled = false
      }
    }

    let dutyLists = document.querySelector("#dutyLists ul")
    Sortable.create(dutyLists, {
      handle: '.handle', // handle's class
      animation: 150
    })
    Array.from(dutyLists.children).forEach(dutyList => {
      Sortable.create(dutyList.querySelector("ul"), {
        handle: '.handle', // handle's class
        animation: 150,
        group: 1
      })
    })
    let stationList = document.querySelector("#stations table tbody")
    Sortable.create(stationList, {
      handle: '.handle', // handle's class
      animation: 150
    })
    Array.from(stationList.children).forEach(station => {
      Sortable.create(stationList.querySelector("ul"), {
        //handle: '.handle', // handle's class
        animation: 150,
      })
    })

    function exportSettings(){
      settings = {}
      let kvSettings = document.getElementById("kvSettings")
      let openHoursSettings = document.getElementById("openHours")
      let dutyContainer = document.querySelector("#dutyLists")
      let stationsSettings = document.getElementById("stations")
      
      let kvInputArr = Array.from(kvSettings.querySelectorAll("input")).filter(input=>!input.classList.contains("template"))
      // console.log(kvInputArr)
      kvInputArr.forEach(input=>{
        settings[input.id] = parseInputTypes(input)
      })

      openHoursObj = Array.from(openHoursSettings.querySelectorAll("tr")).map(tr=>{
        return {
          day: tr.querySelector("td")?.innerText,
          open: parseInputTypes(tr.querySelector("td>input")),
          close: parseInputTypes(tr.querySelectorAll("td>input")[1])
        }
        })
      openHoursObj.shift()
      settings.openHours = openHoursObj

      let dutyListsArr = Array.from(document.querySelectorAll("#dutyLists>ul>li"))
      dutyListsArr.shift()
      dutyListsArr = dutyListsArr.map(list=>{
        let dutyList = Array.from(list.querySelectorAll("ul>li"))
        dutyList.shift()
        return {
          title: list.querySelector(".title").value,
          duties: dutyList.map(listItem=>listItem.querySelector("input").value),
          limitXHours: list.querySelector(".limitXHours").value,
          limitYHours: list.querySelector(".limitYHours").value,
          limitType: list.querySelector(".limitType").value
        }
      })
      settings.dutyLists = dutyListsArr

      stationsTrArr = Array.from(stationsSettings.querySelectorAll("tr")).filter(tr=>!tr.classList.contains("header") && !tr.classList.contains("template"))
      let stationsArr = stationsTrArr.map(tr=>{
        return Array.from(tr.querySelectorAll("td")).filter(td=>td.id != undefined).map(td=>{
          if(td.id=="positionPriority"){
            let key = td.id
            let value = Array.from(td.querySelectorAll("ul>li")).filter(li=>!li.classList.contains("template")).map(li=>{
              let title = li.querySelector("span").innerText
              let enabled = li.querySelector("input")?.checked ? true : false
              return {title:title, enabled:enabled}
            })
            return [key, value]
          }

          let key = td.id
          let value = parseInputTypes(td.querySelector("input, select"))
          return [key, value]
        })
      })
      settings.stations = stationsArr.map(station=>Object.fromEntries(station))

      // console.log(settings)
      // console.log(JSON.stringify(settings, (k,v) => v === undefined ? null : v))

      function parseInputTypes(input){
        if (input == undefined) return undefined
        let val = undefined
        if(input.type == "checkbox") val = input.checked
        else if(input.type == "number") val = isNaN(input.valueAsNumber) ? undefined : input.valueAsNumber
        else if(input.type == "text" || input.value==="") val = input.value
        else if(input.type == "time" && input.value.includes(':')) val = new Date(2000, 0, 1, input.value.split(':')[0], input.value.split(':')[1], 0, 0)
        else val = input.value
        if (val === "") val = undefined
        return val
      }
    }

    function loadSettings(settings){
    //keyvalue settings
      let kvSettingsTable = document.getElementById("kvSettings")
      Array.from(kvSettingsTable.querySelectorAll("tr")).forEach(tr=>{
        if (!tr.classList.contains("template")) tr.remove()
      })
      kvSettings = Object.entries(settings).filter(setting => 
      setting[0] != "openHours"
      && setting[0] != "stations"
      && setting[0] != "dutyLists"
      )
      let kvTooltips=[
        {text:"assignStations", tooltip:"Assign staff to stations. If unchecked, will generate a blank schedule with only meals and events."},
        {text:"defragPrePass", tooltip:"Avoid half hour assignments. May extend stations half an hour past their normal duration limit."},
        {text:"changeOnTheHour", tooltip:"Try to only change station assignments on the hour and not at the half hour."},
        {text:"generatePicAssignments", tooltip:"Assign lead PIC at all times during the day, displayed on timeline at top of schedule."},
        {text:"groupPicsAtTop", tooltip:"Group PIC trained staff at the top of the schedule, above Reference staff."},
        {text:"assignmentLength", tooltip:"After this many hours, try to move staff to another station. Overridden by Duration setting of individual stations."},
        {text:"mealBreakLength", tooltip:"Length of meal breaks in hours. For half hours, format as decimal like 0.5 or 1.5. Will only assign meals to staff working 8+ hours."},
        {text:"idealEarlyMealHour", tooltip:"Try to assign lunch near this time. Will only assign meals to staff working 8+ hours."},
        {text:"idealLateMealHour", tooltip:"Try to assign dinner near this time. Will only assign meals to staff working 8+ hours."},
        {text:"idealMealTimePlusMinusHours", tooltip:"How long before/after above times should meals be assigned when coverage is limited?"},
        {text:"addNamesToEvents", tooltip:`In "Happening Today," display names of all event guests before the title of the event.`},
        {text:"alwaysShowBranchManager", tooltip:"Show branch manager on schedule, even on days they don't work"},
        {text:"alwaysShowAssistantBranchManager", tooltip:"Show ABMs on schedule, even on days they don't work"},
        {text:"alwaysShowAllStaff", tooltip:"Show all staff on schedule, even on days they don't work"},
        {text:"earliestDisplayTime", tooltip:"Cut off any shifts/events earlier than this time"},
        {text:"locationID", tooltip:"The locationID used to identify the branch schedule in When I Work"},
        {text:"googleCalendarID", tooltip:`ID for the programs/meetings calendar. Found in Google Calendar, in the settings for that calendar under "Integrate calendar"`},
        {text:"archiveSheetURL", tooltip:"Past schedules will be automatically hidden, then in one day, moved to this spreadsheet to be archived."},
        {text:"verboseLog", tooltip:"When this is checked, more information will be logged to the Apps Script Console and a debug timeline will popup after schedule generation."},
      ]
      kvSettings.forEach(kv=>{
        let key = kv[0]
        let val = kv[1]
        let tr = kvSettingsTable.querySelector(".template").cloneNode(true)
        tr.classList.remove("template")
        tr.querySelector("input").classList.remove("template")
        tr.querySelector("td").innerHTML = `<span class="tooltip">${key}<p class="tooltiptext">${kvTooltips.find(tt=>tt.text==key)?.tooltip}</p></span>`
        initInput(tr.querySelector("td input"), key, val)
        kvSettingsTable.querySelector("tbody").appendChild(tr)
      })


    //openHours
      let openHoursArr = Array.from(document.getElementById("openHours").querySelectorAll("tr"))
      openHoursArr.shift()
      openHoursArr.forEach((tr, i)=>{
        tr.querySelector("input").value = inputValParse(settings.openHours[i].open)
        tr.querySelectorAll("input")[1].value = inputValParse(settings.openHours[i].close)
      })

    //dutyLists
      let dutyListsEl = document.querySelectorAll("#dutyLists>ul>li")
      Array.from(dutyListsEl).forEach(el=>{
        if (!el.classList.contains("template")) el.remove()
      })
      let dutyListTemplate = document.querySelector("#dutyLists>ul>.template")
      settings.dutyLists.forEach(dutyList=>{
        let newList = dutyListTemplate.cloneNode(true)
        Array.from(newList.querySelectorAll("li")).forEach(el=>{
        if (!el.classList.contains("template")) el.remove()
        })
        newList.classList.remove("template")
        let liTemplate = newList.querySelector(".template")
        newList.querySelector(".title").value = dutyList.title
        newList.querySelector(".limitXHours").value = dutyList.limitXHours
        newList.querySelector(".limitYHours").value = dutyList.limitYHours
        newList.querySelector(".limitType").value = dutyList.limitType
        dutyList.duties.forEach(duty=>{
          let newLi = liTemplate.cloneNode(true)
          newLi.classList.remove("template")
          newLi.querySelector("input").value = duty
          newList.querySelector("ul").appendChild(newLi)
        })
        document.querySelector("#dutyLists>ul").appendChild(newList)
      })

    //stations
      let stationsContainer = document.getElementById("stations")
      let stationsElements = stationsContainer.querySelectorAll("table>tbody>tr")
      Array.from(stationsElements).forEach(el=>{
        if (!el.classList.contains("template")) el.remove()
      })
      let stationTemplate = stationsContainer.querySelector("table>tbody>.template")
      settings.stations.forEach(station=>{
        let newStation = stationTemplate.cloneNode(true)
        newStation.classList.remove("template")
        Object.entries(station).forEach(property=>{
          let key = property[0]
          let value = property[1]
          // console.log("key:", key)
          let propertyEl = newStation.querySelector(`#${key}`)
          if(key == "positionPriority"){
            let positionSoratble = Sortable.create(propertyEl.querySelector("ul"), {
              animation: 150,
              dataIdAttr: 'data-position'
            })

            let positionEls = propertyEl.querySelectorAll("ul>li")
            let currentOrder = [...propertyEl.querySelectorAll("ul>li>span")].filter(el=>!el.classList.contains("template")).map(span=>span.innerText)
            
            propertyEl.querySelector(".buttonSort").onclick = function(){
              let order = positionSoratble.toArray().filter(pos=>defaultOrder.includes(pos))
              order.sort((a,b)=>defaultOrder.indexOf(a) - defaultOrder.indexOf(b))
              positionSoratble.sort(order, true)
            }

            propertyEl.querySelector(".buttonFlip").onclick = function(){
              let order = positionSoratble.toArray()
              positionSoratble.sort(order.reverse(), true)
            }

            Array.from(positionEls).forEach(el => {
              if (!el.classList.contains("template")) el.remove()
            })
            let positionTemplate = propertyEl.querySelector("ul>.template")
            value.forEach(position=>{
              let newPositionEl = positionTemplate.cloneNode(true)
              newPositionEl.classList.remove("template")
              newPositionEl.setAttribute("data-position", position.title)
              newPositionEl.querySelector("span").innerText = position.title
              newPositionEl.querySelector("input").checked = position.enabled
              propertyEl.querySelector("ul").appendChild(newPositionEl)
            })
          }
          else{
            initInput(propertyEl.querySelector("input, select"), key, value)
          }
        })
        stationsContainer.querySelector("table>tbody").appendChild(newStation)
      })

      function initInput(input, key, val){
        if(input.nodeName=="select"){
          input.value = val
        }
        else{
          input.type = inputTypeFromVal(val)
          if (input.type == "checkbox") input.checked = val
          else input.value = inputValParse(val)
        }
        input.id = key
      }
      function inputTypeFromVal(val){
        if (typeof val == 'boolean') return "checkbox"
        if (typeof val == 'number') return "number"
        if (typeof val.getMonth === 'function' || val.includes(".000Z")) return "time"
        if (typeof val == 'string' && val[0]=='#') return "color"
        return "text"
      }
      function inputValParse(val){
        if (typeof val == 'boolean') return val ? "on" : "off"
        if (typeof val == 'number') return val
        if (typeof val.getMonth === 'function') return val.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12:false})
        if (val.includes(".000Z")) return new Date(val).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12:false})
        return val
      }

      Array.from(stationsContainer.querySelectorAll("table>tbody>tr")).forEach(el=>{
        updateLimitInputs(el)
      })
    }
  </script>
</body>

</html>